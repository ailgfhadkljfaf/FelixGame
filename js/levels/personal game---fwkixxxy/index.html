<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D RPG Single Enemy with Loot and Enemy Ranged Attack</title>
<style>
  body { margin: 0; overflow: hidden; font-family: Arial; }
  #hpBarContainer { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 300px; height: 25px; background: #555; border: 2px solid #222; }
  #hpBar { width: 100%; height: 100%; background: #0f0; }
  #enemyHpBarContainer { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 300px; height: 25px; background: #555; border: 2px solid #222; }
  #enemyHpBar { width: 100%; height: 100%; background: #f00; }
  #lootCounter { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 20px; }
</style>
</head>
<body>
<div id="hpBarContainer"><div id="hpBar"></div></div>
<div id="enemyHpBarContainer"><div id="enemyHpBar"></div></div>
<div id="lootCounter">Loot: 0</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Ground
const groundGeometry = new THREE.PlaneGeometry(50, 50);
const groundMaterial = new THREE.MeshStandardMaterial({color: 0x228B22});
const ground = new THREE.Mesh(groundGeometry, groundMaterial);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// Player
const playerGeometry = new THREE.BoxGeometry(1,1,1);
const playerMaterial = new THREE.MeshStandardMaterial({color: 0x0000ff});
const player = new THREE.Mesh(playerGeometry, playerMaterial);
player.position.y = 0.5;
scene.add(player);

// Single Enemy
const enemyGeometry = new THREE.BoxGeometry(1,1,1);
const enemyMaterial = new THREE.MeshStandardMaterial({color: 0xff0000});
const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);
enemy.position.set(5,0.5,0);
enemy.hp = 100;
scene.add(enemy);

// Light
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10,10,10);
scene.add(light);

// Camera
camera.position.set(0,5,10);
camera.lookAt(0,0,0);

// Controls
const keys = {};
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Jump
let isJumping = false;
let verticalVelocity = 0;
const gravity = 0.01;

// Player HP and loot
let playerHp = 100;
let lootCount = 0;
function updateHpBar(){
  const hpBar = document.getElementById('hpBar');
  hpBar.style.width = playerHp+'%';
  hpBar.style.background = playerHp>50?'#0f0':(playerHp>20?'#ff0':'#f00');
}
function updateEnemyHpBar(){
  const enemyHpBar = document.getElementById('enemyHpBar');
  enemyHpBar.style.width = enemy.hp+'%';
}
function updateLoot(){
  document.getElementById('lootCounter').innerText = 'Loot: '+lootCount;
}
updateHpBar();
updateEnemyHpBar();
updateLoot();

// Collision detection
function checkCollision(a,b,distance=1){
  return a.position.distanceTo(b.position)<distance;
}

let lastEnemyHitTime = 0;
const bullets = [];
const lootItems = [];
const enemyFireballs = [];
let lastFireballTime = 0;

function getRandomLootColor(){
  const colors=['#ffff00','#00ffff','#ff00ff'];
  return colors[Math.floor(Math.random()*colors.length)];
}

function enemyAttack(){
  const distanceToPlayer = enemy.position.distanceTo(player.position);
  const now = Date.now();
  // Ranged attack if far enough and cooldown passed
  if(distanceToPlayer > 2 && now - lastFireballTime > 2000){
    const fireballGeometry = new THREE.SphereGeometry(0.2, 8, 8);
    const fireballMaterial = new THREE.MeshStandardMaterial({color: 0xff8800});
    const fireball = new THREE.Mesh(fireballGeometry, fireballMaterial);
    fireball.position.copy(enemy.position);
    fireball.direction = new THREE.Vector3().subVectors(player.position, enemy.position).normalize();
    enemyFireballs.push(fireball);
    scene.add(fireball);
    lastFireballTime = now;
  }

  // Move fireballs
  for(let i=enemyFireballs.length-1;i>=0;i--){
    const f=enemyFireballs[i];
    f.position.add(f.direction.clone().multiplyScalar(0.2));
    if(checkCollision(f, player,1)){
      playerHp -=10;
      if(playerHp<0) playerHp=0;
      updateHpBar();
      scene.remove(f);
      enemyFireballs.splice(i,1);
    } else if(Math.abs(f.position.x)>50||Math.abs(f.position.z)>50){
      scene.remove(f);
      enemyFireballs.splice(i,1);
    }
  }
}

function animate(){
  requestAnimationFrame(animate);

  // Player movement
  if(keys['w']) player.position.z -= 0.1;
  if(keys['s']) player.position.z += 0.1;
  if(keys['a']) player.position.x -= 0.1;
  if(keys['d']) player.position.x += 0.1;

  // Jump
  if(keys[' ']){
    if(!isJumping){
      isJumping=true;
      verticalVelocity=0.2;
    }
  }
  if(isJumping){
    player.position.y += verticalVelocity;
    verticalVelocity -= gravity;
    if(player.position.y<=0.5){
      player.position.y=0.5;
      isJumping=false;
      verticalVelocity=0;
    }
  }

  // Map boundary check
  if(Math.abs(player.position.x)>25||Math.abs(player.position.z)>25){
    alert('You moved out of bounds! You lose.');
    player.position.set(0,0.5,0);
    playerHp=100;
    updateHpBar();
  }

  const now = Date.now();

  // Enemy AI and melee collision
  const dir = new THREE.Vector3().subVectors(player.position, enemy.position).normalize();
  enemy.position.add(dir.multiplyScalar(0.08));

  if(checkCollision(player, enemy) && now-lastEnemyHitTime>500){
    playerHp-=10;
    if(playerHp<0) playerHp=0;
    lastEnemyHitTime=now;
    updateHpBar();
    if(playerHp===0){
      alert('Player defeated!');
      player.position.set(0,0.5,0);
      playerHp=100;
      updateHpBar();
    }
  }

  // Player shooting bullets
  if(keys['f']){
    const bulletGeometry=new THREE.SphereGeometry(0.15,8,8);
    const bulletMaterial=new THREE.MeshStandardMaterial({color:0xffff00});
    const bullet=new THREE.Mesh(bulletGeometry,bulletMaterial);
    bullet.position.set(player.position.x,player.position.y+0.5,player.position.z);
    bullet.direction=new THREE.Vector3(0,0,1);
    bullets.push(bullet);
    scene.add(bullet);
    keys['f']=false;
  }

  // Move bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.position.add(b.direction.clone().multiplyScalar(0.5));
    if(checkCollision(b,enemy,1)){
      enemy.hp-=10;
      scene.remove(b);
      bullets.splice(i,1);
      updateEnemyHpBar();
      if(enemy.hp<=0){
        // Spawn random loot
        const lootGeometry=new THREE.BoxGeometry(0.3,0.3,0.3);
        const lootMaterial=new THREE.MeshStandardMaterial({color:getRandomLootColor()});
        const loot=new THREE.Mesh(lootGeometry,lootMaterial);
        loot.position.copy(enemy.position);
        lootItems.push(loot);
        scene.add(loot);

        // Respawn enemy
        enemy.position.set(Math.random()*20-10,0.5,Math.random()*20-10);
        enemy.hp=100;
        updateEnemyHpBar();
      }
    }else if(Math.abs(b.position.x)>50||Math.abs(b.position.z)>50){
      scene.remove(b);
      bullets.splice(i,1);
    }
  }

  // Collect loot
  for(let i=lootItems.length-1;i>=0;i--){
    const item=lootItems[i];
    if(player.position.distanceTo(item.position)<1){
      lootCount++;
      scene.remove(item);
      lootItems.splice(i,1);
      updateLoot();
    }
  }

  // Enemy ranged attack
  enemyAttack();

  renderer.render(scene,camera);
}

animate();
</script>
</body>
</html>